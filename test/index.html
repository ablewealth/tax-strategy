<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Tax Analysis and Optimization Platform</title>

    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-navy: #0f172a;
            --primary-blue: #1e40af;
            --accent-gold: #d4af37;
            --accent-gold-light: #f4e5a1;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --background-primary: #ffffff;
            --background-secondary: #f8fafc;
            --background-tertiary: #f1f5f9;
            --border-primary: #e2e8f0;
            --border-secondary: #cbd5e1;
            --success: #059669;
            --warning: #d97706;
            --error: #dc2626;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.02);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.02);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.08), 0 4px 6px -4px rgb(0 0 0 / 0.03);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.05);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--text-primary);
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            min-height: 100vh;
            background: var(--background-secondary);
        }

        .header-bar {
            background: var(--background-primary);
            border-bottom: 1px solid var(--border-primary);
            padding: 0 2rem;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-blue) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }

        .brand-info h1 {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .brand-info p {
            font-size: 12px;
            color: var(--text-muted);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .print-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary-blue);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .print-button:hover {
            background: var(--primary-navy);
            box-shadow: var(--shadow-md);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--background-tertiary);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            gap: 2rem;
        }

        .section {
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-primary);
            overflow: hidden;
        }

        .section-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-primary);
            background: var(--background-secondary);
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-description {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0;
        }

        .section-content {
            padding: 2rem;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input, .form-select {
            height: 48px;
            padding: 0 1rem;
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-md);
            font-size: 15px;
            background: var(--background-primary);
            transition: all 0.2s ease;
            color: var(--text-primary);
        }
        
        .form-input[type=text] {
            -moz-appearance: textfield;
        }

        .form-input::-webkit-outer-spin-button,
        .form-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }


        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1rem;
        }

        .strategy-card {
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            background: var(--background-primary);
            transition: all 0.3s ease;
            position: relative;
        }

        .strategy-card:hover {
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .strategy-card.active {
            border-color: var(--accent-gold);
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.05) 0%, rgba(212, 175, 55, 0.02) 100%);
            box-shadow: var(--shadow-lg);
        }

        .strategy-card.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-gold);
            border-radius: var(--radius-sm);
        }

        .strategy-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .strategy-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--accent-gold);
            margin-top: 0.25rem;
        }

        .strategy-info {
            flex: 1;
        }

        .strategy-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            line-height: 1.3;
        }

        .strategy-category {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }

        .strategy-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .strategy-icon {
            font-size: 24px;
            opacity: 0.7;
        }

        .results-dashboard {
            background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-blue) 100%);
            border-radius: var(--radius-xl);
            padding: 3rem;
            color: white;
            margin: 2rem 0;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .dashboard-title {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .dashboard-subtitle {
            font-size: 16px;
            opacity: 0.8;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-4px);
        }

        .metric-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
            margin-bottom: 1rem;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .metric-change {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
        }

        .insights-section {
            display: grid;
            gap: 1rem;
        }

        .insight-card {
            background: var(--background-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            position: relative;
        }

        .insight-card.success {
            border-left: 4px solid var(--success);
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.05) 0%, rgba(5, 150, 105, 0.02) 100%);
        }

        .insight-card.warning {
            border-left: 4px solid var(--warning);
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.05) 0%, rgba(217, 119, 6, 0.02) 100%);
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .insight-icon {
            font-size: 20px;
        }

        .insight-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .insight-message {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .professional-accent {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #b8860b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .chart-container {
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-primary);
        }

        .chart-title {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .chart-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 2rem;
        }

        .chart-canvas-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .app-footer {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            font-size: 12px;
            color: var(--text-muted);
            text-align: justify;
            border-top: 1px solid var(--border-primary);
        }
        .app-footer p {
            margin-bottom: 1rem;
        }
        
        /* Print-specific styles */
        .printable-area {
            display: none; /* Hidden by default */
        }

        @media print {
            /* Hide the main application */
            body > #root {
                display: none;
            }

            /* Make the print mount point and its contents visible */
            body > #print-mount {
                display: block;
            }
            
            html, body {
                width: 100%;
                height: auto;
                background: #fff;
                overflow: visible;
                margin: 0;
                padding: 0;
            }

            .printable-area {
                display: block;
                visibility: visible;
                width: 100%;
                font-family: 'Inter', Arial, sans-serif;
                color: #000;
                padding: 20px;
            }
            
            .printable-area * {
                visibility: visible;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 25px;
                border-bottom: 2px solid #333;
                padding-bottom: 15px;
            }
            .print-header h1 {
                font-size: 22px;
                font-weight: bold;
                margin: 0;
            }
            .print-header p {
                font-size: 12px;
                margin: 4px 0 0;
            }
            
            .print-section {
                margin-bottom: 20px;
            }
            
            .print-section-title {
                font-size: 16px;
                font-weight: bold;
                border-bottom: 1px solid #ccc;
                padding-bottom: 6px;
                margin-bottom: 10px;
            }
            
            .print-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 12px;
            }
            .print-table th, .print-table td {
                border: 1px solid #ccc;
                padding: 6px;
                text-align: left;
            }
            .print-table th {
                background-color: #f2f2f2;
                font-weight: bold;
            }
            .print-table td:nth-child(2) {
                text-align: right;
            }
            
            .print-insights-list {
                list-style-position: inside;
                padding-left: 0;
            }
            
            .print-insight-item {
                font-size: 12px;
                margin-bottom: 8px;
                padding: 8px;
                border: 1px solid #eee;
                border-radius: 4px;
            }
            
            .print-insight-item.success {
                border-left: 3px solid #059669;
            }
            
            .print-insight-item.warning {
                border-left: 3px solid #d97706;
            }

            .print-chart-image {
                max-width: 70%;
                height: auto;
                margin-bottom: 20px;
                display: block;
                margin-left: auto;
                margin-right: auto;
            }
            
            .print-footer {
                margin-top: 30px;
                padding-top: 15px;
                border-top: 1px solid #ccc;
                font-size: 8px;
                color: #666;
                line-height: 1.4;
            }
            .print-footer p {
                margin-bottom: 8px;
            }
            
            .print-section, .print-table, .print-footer {
                page-break-inside: avoid;
            }
        }


        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
                gap: 1rem;
            }

            .hero-section {
                padding: 2rem;
            }

            .hero-title {
                font-size: 28px;
            }

            .section-content {
                padding: 1.5rem;
            }

            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }

            .strategy-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-canvas-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="print-mount"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;

        // Icon mappings
        const strategyIcons = {
            'QUANT_DEALS_01': 'ðŸ“Š',
            'EQUIP_S179_01': 'ðŸ­',
            'CHAR_CLAT_01': 'ðŸ†',
            'OG_USENERGY_01': 'âš¡',
            'FILM_SEC181_01': 'ðŸŽ­',
            'SOLO401K_EMPLOYEE_01': 'ðŸ›ï¸',
            'SOLO401K_EMPLOYER_01': 'ðŸ¦',
            'DB_PLAN_01': 'ðŸ’¼',
            'QBI_FINAL_01': 'ðŸŽ¯'
        };

        // DEALS Strategy Exposure Levels
        const DEALS_EXPOSURE_LEVELS = {
            '130/30': {
                shortTermLossRate: 0.10,
                longTermGainRate: 0.024,
                annualTaxBenefit: 0.035,
                description: '130/30 Strategy',
                subtitle: '3.5% annual tax benefits'
            },
            '145/45': {
                shortTermLossRate: 0.138,
                longTermGainRate: 0.033,
                annualTaxBenefit: 0.046,
                description: '145/45 Strategy',
                subtitle: '4.6% annual tax benefits'
            },
            '175/75': {
                shortTermLossRate: 0.206,
                longTermGainRate: 0.049,
                annualTaxBenefit: 0.069,
                description: '175/75 Strategy',
                subtitle: '6.9% annual tax benefits'
            },
            '225/125': {
                shortTermLossRate: 0.318,
                longTermGainRate: 0.076,
                annualTaxBenefit: 0.106,
                description: '225/125 Strategy',
                subtitle: '10.6% annual tax benefits'
            }
        };

        // Strategy Library
        const STRATEGY_LIBRARY = [
            {
                id: 'QUANT_DEALS_01',
                name: 'Quantino DEALSâ„¢',
                category: 'Systematic Investment',
                description: 'Advanced algorithmic trading system generating strategic capital losses to offset gains while maintaining market exposure through sophisticated risk management protocols.',
                inputRequired: 'investmentAmount',
                type: 'capital'
            },
            {
                id: 'EQUIP_S179_01',
                name: 'Section 179 Acceleration',
                category: 'Business Tax Strategy',
                description: 'Immediate expensing of qualifying business equipment purchases up to $1.22M, providing substantial first-year deductions for operational asset investments.',
                inputRequired: 'equipmentCost',
                type: 'aboveAGI'
            },
            {
                id: 'SOLO401K_EMPLOYEE_01',
                name: 'Solo 401(k) - Employee',
                category: 'Retirement Planning',
                description: 'Employee elective deferral contributions to Solo 401(k) plan, maximizing pre-tax retirement savings with state-specific tax treatment.',
                inputRequired: 'solo401kEmployee',
                type: 'aboveAGI'
            },
            {
                id: 'SOLO401K_EMPLOYER_01',
                name: 'Solo 401(k) - Employer',
                category: 'Retirement Planning',
                description: 'Employer profit-sharing contributions to Solo 401(k) plan, providing additional tax-deferred retirement savings capacity.',
                inputRequired: 'solo401kEmployer',
                type: 'aboveAGI'
            },
            {
                id: 'DB_PLAN_01',
                name: 'Executive Retirement',
                category: 'Executive Retirement',
                description: 'High-contribution defined benefit pension plan for business owners, enabling substantial tax-deferred contributions based on actuarial calculations.',
                inputRequired: 'dbContribution',
                type: 'aboveAGI'
            },
            {
                id: 'CHAR_CLAT_01',
                name: 'Charitable CLAT',
                category: 'Estate & Philanthropic Planning',
                description: 'Sophisticated charitable giving structure providing immediate substantial deductions while preserving wealth transfer opportunities for beneficiaries through grantor trust mechanisms.',
                inputRequired: 'charitableIntent',
                type: 'belowAGI'
            },
            {
                id: 'OG_USENERGY_01',
                name: 'Energy Investment IDCs',
                category: 'Alternative Investment Strategy',
                description: 'Strategic participation in domestic oil & gas ventures providing substantial upfront deductions through Intangible Drilling Costs and percentage depletion benefits.',
                inputRequired: 'ogInvestment',
                type: 'belowAGI'
            },
            {
                id: 'FILM_SEC181_01',
                name: 'Film Financing (Section 181)',
                category: 'Entertainment Investment',
                description: '100% upfront deduction of investment in qualified film production, treated as an active loss for high-income professionals.',
                inputRequired: 'filmInvestment',
                type: 'belowAGI'
            },
            {
                id: 'QBI_FINAL_01',
                name: 'QBI Optimization',
                category: 'Income Strategy Management',
                description: 'Strategic income positioning to maximize the 20% Qualified Business Income deduction through careful management of taxable income thresholds and business structure optimization.',
                inputRequired: 'businessIncome',
                type: 'qbi'
            },
        ];

        // Tax brackets
        const FED_TAX_BRACKETS = [
            { rate: 0.10, min: 0, max: 23200 },
            { rate: 0.12, min: 23201, max: 94300 },
            { rate: 0.22, min: 94301, max: 201050 },
            { rate: 0.24, min: 201051, max: 383900 },
            { rate: 0.32, min: 383901, max: 487450 },
            { rate: 0.35, min: 487451, max: 731200 },
            { rate: 0.37, min: 731201, max: Infinity },
        ];

        const NY_TAX_BRACKETS = [
            { rate: 0.04, min: 0, max: 17150 },
            { rate: 0.045, min: 17151, max: 23900 },
            { rate: 0.0525, min: 23901, max: 27900 },
            { rate: 0.0585, min: 27901, max: 161550 },
            { rate: 0.0625, min: 161551, max: 323200 },
            { rate: 0.0685, min: 323201, max: 2155350 },
            { rate: 0.0965, min: 2155351, max: 5000000 },
            { rate: 0.103, min: 5000001, max: 25000000 },
            { rate: 0.109, min: 25000001, max: Infinity },
        ];

        const NJ_TAX_BRACKETS = [
            { rate: 0.014, min: 0, max: 20000 },
            { rate: 0.0175, min: 20001, max: 35000 },
            { rate: 0.035, min: 35001, max: 40000 },
            { rate: 0.05525, min: 40001, max: 75000 },
            { rate: 0.0637, min: 75001, max: 500000 },
            { rate: 0.0897, min: 500001, max: 1000000 },
            { rate: 0.1075, min: 1000001, max: Infinity },
        ];

        const STANDARD_DEDUCTION = 29200;

        const INITIAL_CLIENT_DATA = {
            clientName: 'John & Jane Doe',
            w2Income: 500000,
            businessIncome: 2000000,
            capitalGains: 1000000,
            state: 'NJ',
            investmentAmount: 500000,
            dealsExposure: '175/75',
            equipmentCost: 150000,
            charitableIntent: 100000,
            ogInvestment: 200000,
            filmInvestment: 100000,
            solo401kEmployee: 23000,
            solo401kEmployer: 50000,
            dbContribution: 120000,
        };

        // Helper Functions
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('en-US', { 
                style: 'currency', 
                currency: 'USD', 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            }).format(Math.max(0, value || 0));
        };

        const formatPercentage = (value) => {
            return `${(value * 100).toFixed(1)}%`;
        };

        const calculateTax = (income, brackets) => {
            if (income <= 0) return 0;
            let tax = 0;
            let remainingIncome = income;

            for (const bracket of brackets) {
                if (remainingIncome <= 0) break;
                const bracketMin = bracket.min || 0;
                const taxableInBracket = Math.max(0, Math.min(income, bracket.max) - bracketMin);
                
                if (taxableInBracket > 0) {
                     tax += (Math.min(remainingIncome, taxableInBracket)) * bracket.rate;
                     remainingIncome -= taxableInBracket;
                }
            }
            return Math.max(0, tax);
        };
        
        // Chart Components
        const TaxComparisonChart = ({ baseline, withStrategies, chartInstanceRef }) => {
            const chartRef = useRef(null);

            useEffect(() => {
                if (!baseline || !withStrategies || !chartRef.current || !window.Chart) return;

                if (chartInstanceRef.current) {
                    chartInstanceRef.current.destroy();
                }
                const ctx = chartRef.current.getContext('2d');
                chartInstanceRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Baseline Scenario', 'Optimized Strategy'],
                        datasets: [
                            {
                                label: 'Federal Tax',
                                data: [baseline.fedTax / 1000, withStrategies.fedTax / 1000],
                                backgroundColor: '#1e40af',
                                borderColor: '#1e40af',
                                borderWidth: 1
                            },
                            {
                                label: 'State Tax',
                                data: [baseline.stateTax / 1000, withStrategies.stateTax / 1000],
                                backgroundColor: '#d4af37',
                                borderColor: '#d4af37',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                grid: { display: false },
                                ticks: { font: { family: 'Inter', size: 12 } }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                grid: { color: '#e2e8f0' },
                                ticks: {
                                    font: { family: 'Inter', size: 12 },
                                    callback: (value) => '$' + Math.round(value) + 'k'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: { family: 'Inter', size: 12 },
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                titleFont: { family: 'Inter', size: 13 },
                                bodyFont: { family: 'Inter', size: 12 },
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        if (context.parsed.y !== null) label += formatCurrency(context.parsed.y * 1000);
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
                
                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                    }
                };
            }, [baseline, withStrategies, chartInstanceRef]);

            return (
                <div className="chart-container">
                    <div className="chart-title">Tax Liability Comparative Analysis</div>
                    <div className="chart-subtitle">Baseline vs. optimized tax scenarios with federal and state breakdown</div>
                    <div className="chart-canvas-container">
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        };

        const StrategicSavingsChart = ({ strategyImpacts, chartInstanceRef }) => {
            const chartRef = useRef(null);

            useEffect(() => {
                if (!strategyImpacts || !chartRef.current || !window.Chart) return;
                
                if (chartInstanceRef.current) {
                    chartInstanceRef.current.destroy();
                }
                
                const filteredImpacts = strategyImpacts.filter(impact => impact.savings > 0);
                const labels = filteredImpacts.map(impact => impact.name);
                const data = filteredImpacts.map(impact => impact.savings);

                const ctx = chartRef.current.getContext('2d');
                chartInstanceRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Tax Savings',
                            data: data,
                            backgroundColor: 'rgba(5, 150, 105, 0.9)',
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                grid: { color: '#e2e8f0' },
                                ticks: {
                                    font: { family: 'Inter', size: 12 },
                                    callback: (value) => formatCurrency(value)
                                }
                            },
                            y: {
                                grid: { display: false },
                                ticks: { font: { family: 'Inter', size: 10 } }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                titleFont: { family: 'Inter', size: 13 },
                                bodyFont: { family: 'Inter', size: 12 },
                                callbacks: {
                                    label: function(context) {
                                        return `Savings: ${formatCurrency(context.parsed.x)}`;
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                    }
                };
            }, [strategyImpacts, chartInstanceRef]);

            return (
                <div className="chart-container">
                    <div className="chart-title">Strategic Savings Analysis</div>
                    <div className="chart-subtitle">Individual contribution of each implemented strategy</div>
                    <div className="chart-canvas-container">
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        };

        // Components
        const Header = ({ onPrint }) => (
            <div className="header-bar">
                <div className="logo-section">
                    <div className="logo-icon">AWM</div>
                    <div className="brand-info">
                        <h1>Advanced Tax Strategy Optimizer</h1>
                        <p>Able Wealth Management</p>
                    </div>
                </div>
                <div className="header-actions">
                    <div className="status-badge">
                        <div className="status-dot"></div>
                        Analysis Active
                    </div>
                    <button onClick={onPrint} className="print-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                          <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1z"/>
                        </svg>
                        Print Report
                    </button>
                </div>
            </div>
        );

        const ClientInputSection = ({ data, setData }) => {
            const handleNumericInputChange = (e) => {
                const { name, value } = e.target;
                const numericValue = Number(value.replace(/[^0-9.-]+/g, '')) || 0;
                setData(prev => ({ ...prev, [name]: Math.max(0, numericValue) }));
            };

            const handleTextChange = (e) => {
                const { name, value } = e.target;
                setData(prev => ({ ...prev, [name]: value }));
            };

            const handleSelectChange = (e) => {
                const { name, value } = e.target;
                setData(prev => ({ ...prev, [name]: value }));
            };

            const renderNumericField = (name, label, description) => (
                <div className="form-field">
                    <label className="form-label">{label}</label>
                    <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '0.5rem' }}>
                        {description}
                    </div>
                    <input
                        type="text"
                        name={name}
                        value={data[name] ? new Intl.NumberFormat('en-US').format(data[name]) : ''}
                        onChange={handleNumericInputChange}
                        className="form-input"
                        placeholder="$ 0"
                    />
                </div>
            );
            
            const renderTextField = (name, label, description) => (
                 <div className="form-field">
                    <label className="form-label">{label}</label>
                    <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '0.5rem' }}>
                        {description}
                    </div>
                    <input
                        type="text"
                        name={name}
                        value={data[name] || ''}
                        onChange={handleTextChange}
                        className="form-input"
                        placeholder="Enter Name"
                    />
                </div>
            );

            const renderSelectField = (name, label, description, options) => (
                <div className="form-field">
                    <label className="form-label">{label}</label>
                    <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '0.5rem' }}>
                        {description}
                    </div>
                    <select 
                        name={name} 
                        value={data[name]} 
                        onChange={handleSelectChange} 
                        className="form-select"
                    >
                        {options.map(option => (
                            <option key={option.value} value={option.value}>
                                {option.label}
                            </option>
                        ))}
                    </select>
                </div>
            );

            return (
                <div className="section">
                    <div className="section-header">
                        <div className="section-title">
                            ðŸ“‹ Client Profile
                        </div>
                        <div className="section-description">
                            Configure client financial parameters for strategic tax optimization modeling
                        </div>
                    </div>
                    <div className="section-content">
                        <div className="grid grid-2">
                            {renderTextField('clientName', 'Client Name', 'Full name of the client for reporting')}
                            {renderSelectField('state', 'State', 'Primary tax residence', [
                                { value: 'NY', label: 'New York (NY)' },
                                { value: 'NJ', label: 'New Jersey (NJ)' }
                            ])}
                            {renderNumericField('w2Income', 'W-2 Income', 'Salary and wages from employment')}
                            {renderNumericField('businessIncome', 'Business Income', 'Schedule C/K-1 business earnings')}
                            {renderNumericField('capitalGains', 'Long-Term Capital Gains', 'Gains from asset sales held > 1 year')}
                            {renderNumericField('investmentAmount', 'Quantino DEALS Investment', 'Total investment in DEALS strategy')}
                            {renderSelectField('dealsExposure', 'DEALS Exposure Level', 'Long/short exposure ratio', 
                                Object.entries(DEALS_EXPOSURE_LEVELS).map(([key, level]) => ({
                                    value: key,
                                    label: `${level.description} - ${level.subtitle}`
                                }))
                            )}
                            {renderNumericField('equipmentCost', 'Equipment Cost', 'Section 179 qualifying equipment')}
                            {renderNumericField('charitableIntent', 'Charitable Intent', 'CLAT appreciated asset value')}
                            {renderNumericField('ogInvestment', 'Oil & Gas Investment', 'Energy sector investment amount')}
                            {renderNumericField('filmInvestment', 'Film Financing', 'Section 181 qualifying investment')}
                            {renderNumericField('solo401kEmployee', 'Solo 401(k) Employee', 'Employee elective deferrals (max $23,000)')}
                            {renderNumericField('solo401kEmployer', 'Solo 401(k) Employer', 'Employer profit-sharing contribution')}
                            {renderNumericField('dbContribution', 'Defined Benefit Plan', 'DB plan employer contribution')}
                        </div>
                    </div>
                </div>
            );
        };

        const StrategiesSection = ({ enabledStrategies, clientData }) => (
            <div className="section">
                <div className="section-header">
                    <div className="section-title">
                        ðŸ’¼ Strategic Tax Optimization Portfolio
                    </div>
                    <div className="section-description">
                        Select advanced tax strategies for implementation and optimization analysis
                    </div>
                </div>
                <div className="section-content">
                    <div className="strategy-grid">
                        {STRATEGY_LIBRARY.map((strategy, index) => {
                            const isActive = enabledStrategies[strategy.id];
                            return (
                                <div key={strategy.id} className={`strategy-card ${isActive ? 'active' : ''}`}>
                                    <div className="strategy-header">
                                        <input 
                                            type="checkbox" 
                                            className="strategy-checkbox"
                                            checked={isActive}
                                            disabled
                                        />
                                        <div className="strategy-info">
                                            <div className="strategy-name">
                                                {index + 1}. {strategy.name}
                                            </div>
                                            <div className="strategy-category">
                                                {strategy.category}
                                            </div>
                                            <div className="strategy-description">
                                                {strategy.description}
                                            </div>
                                        </div>
                                        <div className="strategy-icon">
                                            {strategyIcons[strategy.id] || 'ðŸ“Š'}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>
        );

        const ResultsDashboard = ({ results }) => {
            if (!results?.baseline || !results?.withStrategies) {
                return (
                    <div className="results-dashboard">
                        <div className="dashboard-header">
                            <div className="dashboard-title">Analyzing Tax Optimization</div>
                            <div className="dashboard-subtitle">Computing comprehensive strategic tax planning results</div>
                        </div>
                    </div>
                );
            }

            const totalSavings = results.baseline.totalTax - results.withStrategies.totalTax;
            const savingsPercentage = results.baseline.totalTax > 0 ? totalSavings / results.baseline.totalTax : 0;

            return (
                <div className="results-dashboard">
                    <div className="dashboard-header">
                        <div className="dashboard-title">Executive Tax Optimization Analysis</div>
                        <div className="dashboard-subtitle">Comprehensive strategic tax planning results and optimization metrics</div>
                    </div>
                    <div className="metrics-grid">
                        <div className="metric-card">
                            <div className="metric-label">Baseline Tax Liability</div>
                            <div className="metric-value">{formatCurrency(results.baseline.totalTax)}</div>
                            <div className="metric-change">Pre-optimization scenario</div>
                        </div>
                        <div className="metric-card">
                            <div className="metric-label">Optimized Tax Liability</div>
                            <div className="metric-value">{formatCurrency(results.withStrategies.totalTax)}</div>
                            <div className="metric-change">Post-strategy implementation</div>
                        </div>
                        <div className="metric-card">
                            <div className="metric-label">Total Tax Optimization</div>
                            <div className="metric-value professional-accent">{formatCurrency(totalSavings)}</div>
                            <div className="metric-change">{formatPercentage(savingsPercentage)} effective reduction</div>
                        </div>
                    </div>
                </div>
            );
        };

        const ChartsSection = ({ results, comparisonChartInstance, savingsChartInstance }) => {
            if (!results?.baseline || !results?.withStrategies) {
                return null;
            }

            return (
                <div className="charts-grid">
                    <TaxComparisonChart 
                        baseline={results.baseline} 
                        withStrategies={results.withStrategies}
                        chartInstanceRef={comparisonChartInstance}
                    />
                    <StrategicSavingsChart
                        strategyImpacts={results.strategyImpacts || []}
                        chartInstanceRef={savingsChartInstance}
                    />
                </div>
            );
        };

        const InsightsSection = ({ insights }) => (
            <div className="section">
                <div className="section-header">
                    <div className="section-title">
                        ðŸ’¡ Strategic Implementation Insights
                    </div>
                    <div className="section-description">
                        Tax strategy analysis and optimization recommendations
                    </div>
                </div>
                <div className="section-content">
                    <div className="insights-section">
                        {!insights || insights.length === 0 ? (
                            <div className="insight-card">
                                <div className="insight-header">
                                    <div className="insight-icon">ðŸ“Š</div>
                                    <div className="insight-title">Ready for Analysis</div>
                                </div>
                                <div className="insight-message">
                                    Configure investment amounts in the Client Profile section to generate personalized tax optimization insights and strategic recommendations.
                                </div>
                            </div>
                        ) : (
                            insights.map((insight, index) => (
                                <div key={index} className={`insight-card ${insight.type === 'warning' ? 'warning' : 'success'}`}>
                                    <div className="insight-header">
                                        <div className="insight-icon">
                                            {insight.type === 'warning' ? 'âš ï¸' : 'âœ…'}
                                        </div>
                                        <div className="insight-title">
                                            {insight.type === 'warning' ? 'Implementation Consideration' : 'Strategic Benefit'}
                                        </div>
                                    </div>
                                    <div className="insight-message">{insight.text}</div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            </div>
        );
        
        const AppFooter = () => (
            <footer className="app-footer">
                <p><strong>Disclaimer:</strong> The Advanced Tax Strategy Optimizer is a proprietary modeling tool developed by Able Wealth Management LLC (â€œAWMâ€) for internal use by its advisors and planning professionals. This tool presents hypothetical tax optimization scenarios using inputs provided by the user and applies assumptions and tax rules in effect as of May 2025. The outputs generated are for illustrative purposes only and are intended to demonstrate the potential impact of various tax planning strategies under assumed conditions.</p>
                <p>This calculator does not constitute legal, tax, or investment advice. All data and results are based on modeling assumptions that may not reflect actual outcomes or future tax law changes. The scenarios modeled should not be relied upon for making financial or tax-related decisions. Clients and other users must consult their own qualified tax professionals, legal advisors, or financial consultants before implementing any strategies described.</p>
                <p>Tax laws and interpretations are subject to change, and the effectiveness or applicability of strategies modeled may vary based on a clientâ€™s individual circumstances. Use of the calculator does not create an advisory relationship with AWM, nor does it replace the need for a comprehensive, personalized analysis.</p>
                <p>Able Wealth Management LLC is a registered investment adviser with the U.S. Securities and Exchange Commission (SEC). Registration does not imply a certain level of skill or training. For additional information, please refer to AWMâ€™s Form ADV and Code of Ethics.</p>
            </footer>
        );

        // Printable Report Component
        const PrintableReport = ({ clientData, results, chartImages }) => {
            if (!results || !results.baseline) return null;
            
            const { baseline, withStrategies, enabledStrategies } = results;
            const totalSavings = baseline.totalTax - withStrategies.totalTax;
            const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            return (
                <div className="printable-area">
                    <div className="print-header">
                        <h1>Tax Optimization Analysis Report</h1>
                        <p><strong>For:</strong> {clientData.clientName}</p>
                        <p>Date: {today}</p>
                    </div>
                    
                    <div className="print-section">
                        <h2 className="print-section-title">Executive Summary</h2>
                        <table className="print-table">
                            <tbody>
                                <tr>
                                    <td>Baseline Tax Liability</td>
                                    <td>{formatCurrency(baseline.totalTax)}</td>
                                </tr>
                                <tr>
                                    <td>Optimized Tax Liability</td>
                                    <td>{formatCurrency(withStrategies.totalTax)}</td>
                                </tr>
                                <tr>
                                    <th>Total Potential Savings</th>
                                    <th>{formatCurrency(totalSavings)}</th>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div className="print-section">
                        <h2 className="print-section-title">Visual Analysis</h2>
                        {chartImages.comparison && <img src={chartImages.comparison} className="print-chart-image" alt="Tax Comparison Chart" />}
                    </div>

                    <div className="print-section">
                        <h2 className="print-section-title">Client Financial Profile</h2>
                        <table className="print-table">
                           <thead>
                               <tr>
                                   <th>Parameter</th>
                                   <th>Value</th>
                               </tr>
                           </thead>
                           <tbody>
                                <tr><td>W-2 Income</td><td>{formatCurrency(clientData.w2Income)}</td></tr>
                                <tr><td>Business Income</td><td>{formatCurrency(clientData.businessIncome)}</td></tr>
                                <tr><td>Long-Term Capital Gains</td><td>{formatCurrency(clientData.capitalGains)}</td></tr>
                                <tr><td>State of Residence</td><td>{clientData.state}</td></tr>
                           </tbody>
                        </table>
                    </div>
                    
                    <div className="print-section">
                        <h2 className="print-section-title">Applied Strategies & Investments</h2>
                        <table className="print-table">
                           <thead>
                               <tr>
                                   <th>Strategy / Investment</th>
                                   <th>Amount</th>
                               </tr>
                           </thead>
                           <tbody>
                                {STRATEGY_LIBRARY
                                    .filter(s => enabledStrategies[s.id])
                                    .map(s => (
                                        <tr key={s.id}>
                                            <td>{s.name}</td>
                                            <td>{formatCurrency(clientData[s.inputRequired])}</td>
                                        </tr>
                                    ))
                                }
                           </tbody>
                        </table>
                    </div>

                    <div className="print-section">
                        <h2 className="print-section-title">Implementation Insights</h2>
                        <ul className="print-insights-list">
                            {withStrategies.insights.map((insight, index) => (
                                <li key={index} className={`print-insight-item ${insight.type}`}>
                                    <strong>{insight.type === 'warning' ? 'Consideration: ' : 'Benefit: '}</strong>
                                    {insight.text}
                                </li>
                            ))}
                        </ul>
                    </div>
                    
                    <footer className="print-footer">
                        <p><strong>Disclaimer:</strong> The Advanced Tax Strategy Optimizer is a proprietary modeling tool developed by Able Wealth Management LLC (â€œAWMâ€) for internal use by its advisors and planning professionals. This tool presents hypothetical tax optimization scenarios using inputs provided by the user and applies assumptions and tax rules in effect as of May 2025. The outputs generated are for illustrative purposes only and are intended to demonstrate the potential impact of various tax planning strategies under assumed conditions.</p>
                        <p>This calculator does not constitute legal, tax, or investment advice. All data and results are based on modeling assumptions that may not reflect actual outcomes or future tax law changes. The scenarios modeled should not be relied upon for making financial or tax-related decisions. Clients and other users must consult their own qualified tax professionals, legal advisors, or financial consultants before implementing any strategies described.</p>
                        <p>Tax laws and interpretations are subject to change, and the effectiveness or applicability of strategies modeled may vary based on a clientâ€™s individual circumstances. Use of the calculator does not create an advisory relationship with AWM, nor does it replace the need for a comprehensive, personalized analysis.</p>
                        <p>Able Wealth Management LLC is a registered investment adviser with the U.S. Securities and Exchange Commission (SEC). Registration does not imply a certain level of skill or training. For additional information, please refer to AWMâ€™s Form ADV and Code of Ethics.</p>
                    </footer>
                </div>
            );
        };

        // Main App Component with calculations
        function App() {
            const [clientData, setClientData] = useState(INITIAL_CLIENT_DATA);
            const [chartImages, setChartImages] = useState({ comparison: null, savings: null });
            const printRootRef = useRef(null);
            const comparisonChartInstance = useRef(null);
            const savingsChartInstance = useRef(null);

            const calculationResults = useMemo(() => {
                try {
                    const enabledStrategies = STRATEGY_LIBRARY.reduce((acc, s) => {
                        const inputValue = clientData[s.inputRequired] || 0;
                        acc[s.id] = inputValue > 1;
                        return acc;
                    }, {});

                    // --- BASELINE CALCULATIONS ---
                    const baseline = {};
                    baseline.ordinaryIncome = (clientData.w2Income || 0) + (clientData.businessIncome || 0);
                    baseline.fedTaxableIncome = Math.max(0, baseline.ordinaryIncome - STANDARD_DEDUCTION);
                    baseline.fedOrdinaryTax = calculateTax(baseline.fedTaxableIncome, FED_TAX_BRACKETS);
                    baseline.fedCapitalGainsTax = (clientData.capitalGains || 0) * 0.20;
                    baseline.fedTax = baseline.fedOrdinaryTax + baseline.fedCapitalGainsTax;

                    const stateBrackets = clientData.state === 'NY' ? NY_TAX_BRACKETS : NJ_TAX_BRACKETS;
                    baseline.stateTaxableIncome = baseline.ordinaryIncome + (clientData.capitalGains || 0);
                    baseline.stateTax = calculateTax(baseline.stateTaxableIncome, stateBrackets);
                    baseline.totalTax = baseline.fedTax + baseline.stateTax;

                    // --- STRATEGY CALCULATIONS ---
                    let currentTax = baseline.totalTax;
                    const withStrategies = { ...baseline }; // Start with baseline
                    let insights = [];
                    let strategyImpacts = [];
                    
                    let tempFedDeductions = { aboveAGI: 0, belowAGI: 0, qbi: 0 };
                    let tempStateDeductions = { total: 0 };
                    let tempNjAddBack = 0;
                    let tempCurrentFedCapitalGains = clientData.capitalGains || 0;
                    let tempCurrentStateCapitalGains = clientData.capitalGains || 0;
                    let tempQbiBaseIncome = clientData.businessIncome || 0;

                    const calculateCurrentTotalTax = (fedDeductions, stateDeductions, njAddBack, currentFedCG, currentStateCG, qbiBaseIncome, qbiEnabled) => {
                        const fedAGI = (clientData.w2Income || 0) + (clientData.businessIncome || 0) - fedDeductions.aboveAGI;
                        
                        let qbiDeduction = 0;
                        if (qbiEnabled && qbiBaseIncome > 0) {
                            const fedTaxableIncomePreQBI = Math.max(0, fedAGI - STANDARD_DEDUCTION - fedDeductions.belowAGI);
                            const threshold = 383900;
                            if (fedTaxableIncomePreQBI <= threshold) {
                                qbiDeduction = Math.min(qbiBaseIncome * 0.20, fedTaxableIncomePreQBI * 0.20);
                            }
                        }

                        const fedTaxableIncome = Math.max(0, fedAGI - STANDARD_DEDUCTION - fedDeductions.belowAGI - qbiDeduction);
                        const fedOrdinaryTax = calculateTax(fedTaxableIncome, FED_TAX_BRACKETS);
                        const fedCapitalGainsTax = Math.max(0, currentFedCG) * 0.20;
                        const fedTax = fedOrdinaryTax + fedCapitalGainsTax;

                        const stateTaxableIncome = Math.max(0, baseline.ordinaryIncome - stateDeductions.total + njAddBack + currentStateCG);
                        const stateTax = calculateTax(stateTaxableIncome, stateBrackets);
                        
                        return fedTax + stateTax;
                    };


                    STRATEGY_LIBRARY.filter(s => enabledStrategies[s.id] && s.type !== 'qbi').forEach(strategy => {
                        const taxBefore = calculateCurrentTotalTax(tempFedDeductions, tempStateDeductions, tempNjAddBack, tempCurrentFedCapitalGains, tempCurrentStateCapitalGains, tempQbiBaseIncome, false);

                        let fedDed = 0;
                        let stateDed = 0;

                        switch (strategy.id) {
                             case 'EQUIP_S179_01':
                                fedDed = Math.min(clientData.equipmentCost || 0, tempQbiBaseIncome, 1220000);
                                if (clientData.state === 'NY') {
                                    stateDed = fedDed;
                                } else { // NJ
                                    const njDed = Math.min(clientData.equipmentCost || 0, 25000);
                                    const addBack = Math.max(0, (clientData.equipmentCost || 0) - njDed);
                                    stateDed = njDed;
                                    tempNjAddBack += addBack;
                                    if (addBack > 0) insights.push({ type: 'warning', text: `NJ requires a ${formatCurrency(addBack)} depreciation add-back.` });
                                }
                                tempQbiBaseIncome -= fedDed;
                                insights.push({ type: 'success', text: `Section 179 provides a ${formatCurrency(fedDed)} federal deduction.` });
                                tempFedDeductions.aboveAGI += fedDed;
                                tempStateDeductions.total += stateDed;
                                break;
                            case 'SOLO401K_EMPLOYEE_01':
                                fedDed = Math.min(clientData.solo401kEmployee || 0, 23000);
                                if (clientData.state === 'NY') stateDed = fedDed;
                                else { // NJ
                                    tempNjAddBack += fedDed;
                                    insights.push({ type: 'warning', text: `NJ taxes Solo 401(k) employee deferrals. ${formatCurrency(fedDed)} add-back required.` });
                                }
                                insights.push({ type: 'success', text: `Solo 401(k) employee contribution of ${formatCurrency(fedDed)} reduces federal AGI.` });
                                tempFedDeductions.aboveAGI += fedDed;
                                tempStateDeductions.total += stateDed;
                                break;
                            case 'SOLO401K_EMPLOYER_01':
                                fedDed = clientData.solo401kEmployer || 0;
                                stateDed = fedDed;
                                tempQbiBaseIncome -= fedDed;
                                insights.push({ type: 'success', text: `Solo 401(k) employer contribution of ${formatCurrency(fedDed)} reduces business income.` });
                                tempFedDeductions.aboveAGI += fedDed;
                                tempStateDeductions.total += stateDed;
                                break;
                            case 'DB_PLAN_01':
                                fedDed = clientData.dbContribution || 0;
                                stateDed = fedDed;
                                tempQbiBaseIncome -= fedDed;
                                insights.push({ type: 'success', text: `Defined Benefit plan contribution of ${formatCurrency(fedDed)} reduces business income.` });
                                tempFedDeductions.aboveAGI += fedDed;
                                tempStateDeductions.total += stateDed;
                                break;
                            case 'QUANT_DEALS_01':
                                const exposure = DEALS_EXPOSURE_LEVELS[clientData.dealsExposure];
                                const shortTermLosses = (clientData.investmentAmount || 0) * exposure.shortTermLossRate;
                                const longTermGains = (clientData.investmentAmount || 0) * exposure.longTermGainRate;
                                const gainOffset = Math.min(tempCurrentFedCapitalGains, shortTermLosses);
                                const ordinaryOffset = Math.min(3000, shortTermLosses - gainOffset);
                                
                                tempCurrentFedCapitalGains = tempCurrentFedCapitalGains - gainOffset + longTermGains;
                                tempCurrentStateCapitalGains = tempCurrentStateCapitalGains - gainOffset + longTermGains;
                                tempFedDeductions.belowAGI += ordinaryOffset;
                                tempStateDeductions.total += ordinaryOffset;
                                insights.push({ type: 'success', text: `DEALS strategy generated ${formatCurrency(gainOffset)} in capital loss offsets and a ${formatCurrency(ordinaryOffset)} ordinary income deduction.` });
                                break;
                            case 'CHAR_CLAT_01':
                                const fedAGIForClat = (clientData.w2Income || 0) + (clientData.businessIncome || 0) - tempFedDeductions.aboveAGI;
                                fedDed = Math.min(clientData.charitableIntent || 0, fedAGIForClat * 0.30);
                                if (fedDed < (clientData.charitableIntent || 0)) insights.push({ type: 'warning', text: `Charitable deduction limited by AGI to ${formatCurrency(fedDed)}.` });
                                if (clientData.state === 'NY') stateDed = fedDed * 0.5;
                                insights.push({ type: 'success', text: `CLAT provides a ${formatCurrency(fedDed)} federal itemized deduction.` });
                                tempFedDeductions.belowAGI += fedDed;
                                tempStateDeductions.total += stateDed;
                                break;
                            case 'OG_USENERGY_01':
                                fedDed = (clientData.ogInvestment || 0) * 0.70;
                                if (clientData.state === 'NY') stateDed = fedDed;
                                insights.push({ type: 'success', text: `Oil & Gas investment generates a ${formatCurrency(fedDed)} deduction.` });
                                tempFedDeductions.belowAGI += fedDed;
                                tempStateDeductions.total += stateDed;
                                break;
                            case 'FILM_SEC181_01':
                                fedDed = clientData.filmInvestment || 0;
                                if (clientData.state === 'NY') stateDed = fedDed;
                                insights.push({ type: 'success', text: `Film financing provides a ${formatCurrency(fedDed)} deduction.` });
                                tempFedDeductions.belowAGI += fedDed;
                                tempStateDeductions.total += stateDed;
                                break;
                        }

                        const taxAfter = calculateCurrentTotalTax(tempFedDeductions, tempStateDeductions, tempNjAddBack, tempCurrentFedCapitalGains, tempCurrentStateCapitalGains, tempQbiBaseIncome, false);
                        const savings = taxBefore - taxAfter;
                        if (savings > 0) {
                            strategyImpacts.push({ name: strategy.name, savings: savings });
                        }
                    });

                    // QBI Calculation (final step)
                    const taxBeforeQBI = calculateCurrentTotalTax(tempFedDeductions, tempStateDeductions, tempNjAddBack, tempCurrentFedCapitalGains, tempCurrentStateCapitalGains, tempQbiBaseIncome, false);
                    
                    const fedAGI = (clientData.w2Income || 0) + (clientData.businessIncome || 0) - tempFedDeductions.aboveAGI;
                    let qbiDeduction = 0;
                    if (enabledStrategies['QBI_FINAL_01'] && tempQbiBaseIncome > 0) {
                        const fedTaxableIncomePreQBI = Math.max(0, fedAGI - STANDARD_DEDUCTION - tempFedDeductions.belowAGI);
                        const threshold = 383900;
                        if (fedTaxableIncomePreQBI <= threshold) {
                            qbiDeduction = Math.min(tempQbiBaseIncome * 0.20, fedTaxableIncomePreQBI * 0.20);
                            insights.push({ type: 'success', text: `QBI deduction of ${formatCurrency(qbiDeduction)} unlocked.` });
                        } else {
                            insights.push({ type: 'warning', text: `Taxable income exceeds QBI threshold. No QBI deduction available.` });
                        }
                    }
                    tempFedDeductions.qbi = qbiDeduction;

                    withStrategies.fedTaxableIncome = Math.max(0, fedAGI - STANDARD_DEDUCTION - tempFedDeductions.belowAGI - tempFedDeductions.qbi);
                    withStrategies.fedOrdinaryTax = calculateTax(withStrategies.fedTaxableIncome, FED_TAX_BRACKETS);
                    withStrategies.fedCapitalGainsTax = Math.max(0, tempCurrentFedCapitalGains) * 0.20;
                    withStrategies.fedTax = withStrategies.fedOrdinaryTax + withStrategies.fedCapitalGainsTax;

                    withStrategies.stateTaxableIncome = Math.max(0, baseline.ordinaryIncome - tempStateDeductions.total + tempNjAddBack + tempCurrentStateCapitalGains);
                    withStrategies.stateTax = calculateTax(withStrategies.stateTaxableIncome, stateBrackets);
                    withStrategies.totalTax = withStrategies.fedTax + withStrategies.stateTax;
                    withStrategies.insights = insights;

                    const qbiSavings = taxBeforeQBI - withStrategies.totalTax;
                    if (qbiSavings > 0) {
                        strategyImpacts.push({ name: 'QBI Optimization', savings: qbiSavings });
                    }

                    return { baseline, withStrategies, enabledStrategies, strategyImpacts };
                } catch (error) {
                    console.error('Calculation error:', error);
                    return {
                        baseline: { fedTax: 0, stateTax: 0, totalTax: 0 },
                        withStrategies: { fedTax: 0, stateTax: 0, totalTax: 0, insights: [{type: 'error', text: 'A calculation error occurred.'}] },
                        enabledStrategies: {},
                        strategyImpacts: []
                    };
                }
            }, [clientData]);
            
            // Effect to render the printable component into its dedicated DOM node
            useEffect(() => {
                const printContainer = document.getElementById('print-mount');
                if (!printRootRef.current) {
                    printRootRef.current = createRoot(printContainer);
                }
                printRootRef.current.render(<PrintableReport clientData={clientData} results={calculationResults} chartImages={chartImages} />);
            }, [clientData, calculationResults, chartImages]);

            const handlePrint = () => {
                const comparisonImg = comparisonChartInstance.current?.toBase64Image();
                const savingsImg = savingsChartInstance.current?.toBase64Image();
                
                setChartImages({ comparison: comparisonImg, savings: savingsImg });
                
                setTimeout(() => {
                    window.print();
                }, 100);
            };

            return (
                <div className="app-container">
                    <Header onPrint={handlePrint} />
                    <div className="main-content">
                        <ClientInputSection data={clientData} setData={setClientData} />
                        <StrategiesSection enabledStrategies={calculationResults.enabledStrategies} clientData={clientData} />
                        <ResultsDashboard results={calculationResults} />
                        <ChartsSection 
                            results={calculationResults}
                            comparisonChartInstance={comparisonChartInstance}
                            savingsChartInstance={savingsChartInstance}
                        />
                        <InsightsSection insights={calculationResults.withStrategies.insights} />
                    </div>
                    <AppFooter />
                </div>
            );
        }

        // Initialize app
        if (window.React && window.ReactDOM) {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        }
    </script>
</body>
</html>
