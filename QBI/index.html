<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QBI Deduction Calculator - Current vs Final OBBB Rules</title>
  
  <!-- External Dependencies -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #c0a172;
      --primary-hover: #ab8c61;
      --border-color: #dee2e6;
      --focus-ring: rgba(192, 161, 114, 0.2);
      --shadow-base: 0 6px 18px rgba(0, 0, 0, 0.05);
      --shadow-tooltip: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #f8f9fa;
      color: #343a40;
      line-height: 1.6;
    }

    /* Form Elements */
    .form-input, .form-select {
      border: 1px solid #ced4da;
      font-size: 0.875rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      transition: all 0.2s ease;
      width: 100%;
    }

    .form-input:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px var(--focus-ring);
      outline: none;
    }

    .form-input:invalid {
      border-color: #dc3545;
    }

    /* Cards */
    .card {
      background: #fff;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-base);
      border-radius: 0.75rem;
      padding: 2rem;
    }

    /* Button */
    .btn-primary {
      background: var(--primary-color);
      color: #fff;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.875rem;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Tooltips */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip-text {
      visibility: hidden;
      width: 280px;
      background: #343a40;
      color: #fff;
      text-align: left;
      border-radius: 8px;
      padding: 12px;
      position: absolute;
      z-index: 1000;
      bottom: 130%;
      left: 50%;
      margin-left: -140px;
      opacity: 0;
      transition: opacity 0.3s ease;
      font-size: 0.875rem;
      line-height: 1.5;
      box-shadow: var(--shadow-tooltip);
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Results Table */
    .results-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
      overflow: hidden;
      border-radius: 0.5rem;
      box-shadow: var(--shadow-base);
    }

    .results-table th {
      background: #f8f9fa;
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid var(--border-color);
    }

    .results-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f1f3f4;
    }

    .results-table tbody tr:hover {
      background: #f8f9fa;
    }

    /* Status Indicators */
    .status-good { color: #28a745; }
    .status-warn { color: #fd7e14; }
    .status-bad { color: #dc3545; }

    /* Details Section */
    .details-content {
      background: #fff;
      border-left: 3px solid var(--primary-color);
      padding: 1rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
    }

    /* Grid Layouts */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
    }

    /* Loading State */
    .loading {
      pointer-events: none;
      opacity: 0.7;
    }

    /* Error Messages */
    .error-message {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .card {
        padding: 1.5rem;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .tooltip-text {
        width: 240px;
        margin-left: -120px;
      }
    }
  </style>
</head>

<body class="p-6 md:p-10">
  <header class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800">Qualified Business Income (QBI) Deduction Calculator</h1>
    <p class="text-gray-600 mt-2">Compare current law (2025) vs. OBBB final rules (2026+)</p>
  </header>

  <!-- Business Profile Section -->
  <section class="card mb-8">
    <h2 class="text-2xl font-semibold mb-6 text-gray-700">Business Profile</h2>
    <div class="form-grid">
      <div>
        <label for="entityType" class="block text-base font-medium text-gray-700 mb-2">Business Structure</label>
        <select id="entityType" class="form-select">
          <option value="llc-partnership">LLC (taxed as Partnership)</option>
          <option value="llc-scorp">LLC (taxed as S Corp)</option>
          <option value="scorp">S Corporation</option>
          <option value="partnership">Partnership</option>
          <option value="sole-prop">Sole Proprietorship</option>
        </select>
      </div>

      <div class="tooltip">
        <label for="isSSTB" class="block text-base font-medium text-gray-700 mb-2">
          Specified Service Trade or Business (SSTB)?
          <span class="text-gray-400 ml-1">ⓘ</span>
        </label>
        <select id="isSSTB" class="form-select">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
        <span class="tooltip-text">
          An SSTB includes health, law, accounting, financial services, consulting, 
          engineering, architecture, performing arts, and other professional services.
        </span>
      </div>

      <div>
        <label for="numOwners" class="block text-base font-medium text-gray-700 mb-2">Number of Owners/Partners</label>
        <input id="numOwners" type="number" min="1" max="10" value="1" class="form-input" required>
        <div class="error-message" id="numOwners-error">Please enter a valid number of owners (1-10)</div>
      </div>

      <div>
        <label for="totalW2" class="block text-base font-medium text-gray-700 mb-2">Total W-2 Wages Paid by Business</label>
        <input id="totalW2" type="number" min="0" step="100" value="80000" class="form-input" required>
        <div class="error-message" id="totalW2-error">Please enter a valid wage amount</div>
      </div>

      <div class="tooltip">
        <label for="totalUBIA" class="block text-base font-medium text-gray-700 mb-2">
          Total UBIA of Qualified Property
          <span class="text-gray-400 ml-1">ⓘ</span>
        </label>
        <input id="totalUBIA" type="number" min="0" step="100" value="300000" class="form-input" required>
        <span class="tooltip-text">
          UBIA = Unadjusted Basis Immediately After Acquisition. This is the original cost 
          of qualified property used in the business.
        </span>
        <div class="error-message" id="totalUBIA-error">Please enter a valid UBIA amount</div>
      </div>

      <div class="tooltip">
        <label for="totalPTET" class="block text-base font-medium text-gray-700 mb-2">
          State & Local Taxes Paid by Entity (PTET)
          <span class="text-gray-400 ml-1">ⓘ</span>
        </label>
        <input id="totalPTET" type="number" min="0" step="100" value="0" class="form-input" required>
        <span class="tooltip-text">
          Pass-Through Entity Tax is currently fully deductible and reduces QBI for 
          purposes of the Section 199A deduction.
        </span>
        <div class="error-message" id="totalPTET-error">Please enter a valid PTET amount</div>
      </div>
    </div>
  </section>

  <!-- Owner/Partner Sections -->
  <div id="ownersContainer"></div>

  <!-- Action Button -->
  <div class="mt-8 text-center">
    <button id="analyzeBtn" class="btn-primary" onclick="QBICalculator.runAnalysis()">
      <span id="analyzeText">Analyze Scenarios</span>
      <span id="analyzeSpinner" class="hidden">Calculating...</span>
    </button>
  </div>

  <!-- Results Section -->
  <section id="resultsContainer" class="hidden mt-12">
    <h2 class="text-2xl font-semibold mb-6 text-gray-700">Comparative Analysis</h2>

    <div class="overflow-x-auto">
      <table class="results-table">
        <thead>
          <tr>
            <th class="text-left">Owner / Metric</th>
            <th class="text-right">Current Law<br><span class="font-normal text-sm">(2025)</span></th>
            <th class="text-right">Final Bill<br><span class="font-normal text-sm">(OBBB 2026+)</span></th>
            <th class="text-right">Difference</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>

    <div id="thresholdStatus" class="mt-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg">
      <p class="text-blue-800 font-medium">Key Changes in OBBB:</p>
      <ul class="text-blue-700 mt-2 list-disc list-inside text-sm">
        <li>Phase-in ranges widened to $75,000 / $150,000</li>
        <li>$400 minimum deduction when materially participating and QBI ≥ $1,000</li>
      </ul>
    </div>

    <details class="details-content mt-6">
      <summary class="cursor-pointer font-semibold text-gray-700 hover:text-gray-900">
        View Detailed Calculations
      </summary>
      <pre id="detailsLog" class="mt-4 text-xs md:text-sm whitespace-pre-wrap font-mono bg-gray-50 p-4 rounded overflow-x-auto"></pre>
    </details>
  </section>

  <script>
    const QBICalculator = (function() {
      'use strict';

      // Constants
      const THRESHOLDS = {
        current: {
          'single': { lower: 197300, range: 50000 },
          'married-jointly': { lower: 394600, range: 100000 },
          'married-separately': { lower: 197300, range: 50000 },
          'head-of-household': { lower: 197300, range: 50000 }
        },
        obbb: {
          'single': { lower: 197300, range: 75000 },
          'married-jointly': { lower: 394600, range: 150000 },
          'married-separately': { lower: 197300, range: 75000 },
          'head-of-household': { lower: 197300, range: 75000 }
        }
      };

      const CPI_ADJUSTMENT = 1.00; // Future inflation adjustment hook

      // DOM Elements
      const elements = {
        numOwners: null,
        ownersContainer: null,
        analyzeBtn: null,
        resultsContainer: null,
        resultsBody: null,
        detailsLog: null,
        analyzeText: null,
        analyzeSpinner: null
      };

      // Utility Functions
      const utils = {
        formatCurrency: (amount) => {
          const abs = Math.abs(amount);
          const sign = amount < 0 ? '-' : '';
          return `${sign}$${abs.toLocaleString('en-US')}`;
        },

        validateNumber: (value, min = 0, max = Infinity) => {
          const num = parseFloat(value);
          return !isNaN(num) && num >= min && num <= max;
        },

        showError: (fieldId, message) => {
          const errorElement = document.getElementById(`${fieldId}-error`);
          if (errorElement) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
          }
        },

        hideError: (fieldId) => {
          const errorElement = document.getElementById(`${fieldId}-error`);
          if (errorElement) {
            errorElement.style.display = 'none';
          }
        },

        inflateThreshold: (threshold, cpi = CPI_ADJUSTMENT) => ({
          lower: Math.round(threshold.lower * cpi),
          upper: Math.round((threshold.lower + threshold.range) * cpi),
          range: Math.round(threshold.range * cpi)
        })
      };

      // Validation
      const validation = {
        validateBusinessProfile: () => {
          let isValid = true;
          const fields = ['numOwners', 'totalW2', 'totalUBIA', 'totalPTET'];
          
          fields.forEach(field => {
            const element = document.getElementById(field);
            const value = element.value;
            
            utils.hideError(field);
            
            if (field === 'numOwners') {
              if (!utils.validateNumber(value, 1, 10)) {
                utils.showError(field, 'Please enter a valid number of owners (1-10)');
                isValid = false;
              }
            } else {
              if (!utils.validateNumber(value, 0)) {
                utils.showError(field, 'Please enter a valid positive number');
                isValid = false;
              }
            }
          });
          
          return isValid;
        },

        validateOwner: (ownerNum) => {
          let isValid = true;
          const fields = ['taxableIncome', 'netCapGain', 'qbiAllocated', 'ownershipPct'];
          
          fields.forEach(field => {
            const element = document.getElementById(`${field}${ownerNum}`);
            const value = element.value;
            const fieldId = `${field}${ownerNum}`;
            
            utils.hideError(fieldId);
            
            if (field === 'ownershipPct') {
              if (!utils.validateNumber(value, 0, 100)) {
                utils.showError(fieldId, 'Ownership must be between 0% and 100%');
                isValid = false;
              }
            } else {
              if (!utils.validateNumber(value)) {
                utils.showError(fieldId, 'Please enter a valid number');
                isValid = false;
              }
            }
          });
          
          return isValid;
        }
      };

      // Owner Management
      const ownerManager = {
        generateOwnerInputs: () => {
          const count = Math.max(1, parseInt(elements.numOwners.value) || 1);
          elements.ownersContainer.innerHTML = '';
          
          for (let i = 1; i <= count; i++) {
            elements.ownersContainer.insertAdjacentHTML('beforeend', ownerManager.createOwnerCard(i, count));
          }
        },

        createOwnerCard: (index, totalOwners) => {
          const defaultOwnership = (100 / totalOwners).toFixed(1);
          
          return `
            <section class="card mt-8">
              <h3 class="text-xl font-semibold mb-6 text-gray-700">Owner/Partner ${index} Profile</h3>
              <div class="form-grid">
                <div>
                  <label for="ownerLabel${index}" class="block text-base font-medium text-gray-700 mb-2">Owner Label</label>
                  <input type="text" id="ownerLabel${index}" value="Partner ${index}" class="form-input">
                </div>
                
                <div>
                  <label for="filingStatus${index}" class="block text-base font-medium text-gray-700 mb-2">Filing Status</label>
                  <select id="filingStatus${index}" class="form-select">
                    <option value="single">Single</option>
                    <option value="married-jointly">Married Filing Jointly</option>
                    <option value="married-separately">Married Filing Separately</option>
                    <option value="head-of-household">Head of Household</option>
                  </select>
                </div>
                
                <div>
                  <label for="taxableIncome${index}" class="block text-base font-medium text-gray-700 mb-2">Taxable Income (TI)</label>
                  <input type="number" id="taxableIncome${index}" value="250000" step="100" class="form-input" required>
                  <div class="error-message" id="taxableIncome${index}-error">Please enter a valid income amount</div>
                </div>
                
                <div>
                  <label for="netCapGain${index}" class="block text-base font-medium text-gray-700 mb-2">Net Capital Gain (in TI)</label>
                  <input type="number" id="netCapGain${index}" value="0" step="100" class="form-input" required>
                  <div class="error-message" id="netCapGain${index}-error">Please enter a valid capital gain amount</div>
                </div>
                
                <div>
                  <label for="qbiAllocated${index}" class="block text-base font-medium text-gray-700 mb-2">QBI Allocated to Owner</label>
                  <input type="number" id="qbiAllocated${index}" value="100000" step="100" class="form-input" required>
                  <div class="error-message" id="qbiAllocated${index}-error">Please enter a valid QBI amount</div>
                </div>
                
                <div>
                  <label for="ownershipPct${index}" class="block text-base font-medium text-gray-700 mb-2">Ownership %</label>
                  <input type="number" id="ownershipPct${index}" value="${defaultOwnership}" step="0.1" min="0" max="100" class="form-input" required>
                  <div class="error-message" id="ownershipPct${index}-error">Ownership must be between 0% and 100%</div>
                </div>
                
                <div>
                  <label for="matPart${index}" class="block text-base font-medium text-gray-700 mb-2">Materially Participates?</label>
                  <select id="matPart${index}" class="form-select">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                  </select>
                </div>
              </div>
            </section>
          `;
        }
      };

      // Calculation Engine
      const calculator = {
        calculateCurrent: (owner, business, log) => {
          const threshold = utils.inflateThreshold(THRESHOLDS.current[owner.filingStatus]);
          const adjustedQBI = owner.qbi - business.ptetAllocation;
          
          log.push(`Adjusted QBI: ${utils.formatCurrency(owner.qbi)} − ${utils.formatCurrency(business.ptetAllocation)} = ${utils.formatCurrency(adjustedQBI)}`);
          
          if (adjustedQBI <= 0) {
            log.push('QBI ≤ 0 → $0 deduction');
            return calculator.createSummary(0, 0, 0, 0, 0, adjustedQBI);
          }

          const tentativeAmount = 0.20 * adjustedQBI;
          const wageQualifiedProperty = Math.max(
            business.w2Allocation * 0.50,
            business.w2Allocation * 0.25 + business.ubiaAllocation * 0.025
          );
          
          const qbiComponent = calculator.calculatePhaseIn(tentativeAmount, wageQualifiedProperty, threshold, owner, business);
          const overallLimit = 0.20 * Math.max(0, owner.taxableIncome - owner.netCapitalGain);
          const finalDeduction = Math.min(qbiComponent, overallLimit);

          return calculator.createSummary(tentativeAmount, wageQualifiedProperty, qbiComponent, overallLimit, finalDeduction, adjustedQBI);
        },

        calculateOBBB: (owner, business, log) => {
          const threshold = utils.inflateThreshold(THRESHOLDS.obbb[owner.filingStatus]);
          const adjustedQBI = owner.qbi - business.ptetAllocation;
          
          log.push(`Adjusted QBI: ${utils.formatCurrency(owner.qbi)} − ${utils.formatCurrency(business.ptetAllocation)} = ${utils.formatCurrency(adjustedQBI)}`);
          
          if (adjustedQBI <= 0) {
            log.push('QBI ≤ 0 → $0 deduction');
            return calculator.createSummary(0, 0, 0, 0, 0, adjustedQBI);
          }

          const tentativeAmount = 0.20 * adjustedQBI;
          const wageQualifiedProperty = Math.max(
            business.w2Allocation * 0.50,
            business.w2Allocation * 0.25 + business.ubiaAllocation * 0.025
          );
          
          const qbiComponent = calculator.calculatePhaseIn(tentativeAmount, wageQualifiedProperty, threshold, owner, business);
          const overallLimit = 0.20 * Math.max(0, owner.taxableIncome - owner.netCapitalGain);
          let finalDeduction = Math.min(qbiComponent, overallLimit);

          // Apply $400 minimum for material participation
          if (owner.materiallyParticipates === 'yes' && adjustedQBI >= 1000) {
            finalDeduction = Math.max(finalDeduction, 400);
            if (finalDeduction === 400) {
              log.push('Applied $400 minimum deduction for material participation');
            }
          }

          return calculator.createSummary(tentativeAmount, wageQualifiedProperty, qbiComponent, overallLimit, finalDeduction, adjustedQBI);
        },

        calculatePhaseIn: (tentativeAmount, wageQualifiedProperty, threshold, owner, business) => {
          if (owner.taxableIncome <= threshold.lower) {
            return tentativeAmount;
          }
          
          if (owner.taxableIncome > threshold.upper) {
            return business.isSSTB === 'yes' ? 0 : Math.min(tentativeAmount, wageQualifiedProperty);
          }
          
          const phaseInPercentage = (owner.taxableIncome - threshold.lower) / threshold.range;
          const excess = Math.max(0, tentativeAmount - wageQualifiedProperty);
          return tentativeAmount - (excess * phaseInPercentage);
        },

        createSummary: (tentative, wageQP, qbiComp, overallLimit, final, adjustedQBI) => ({
          tentative,
          wageQualifiedProperty: wageQP,
          qbiComponent: qbiComp,
          overallLimit,
          final,
          adjustedQBI
        })
      };

      // Main Analysis Function
      const runAnalysis = () => {
        // Show loading state
        elements.analyzeBtn.disabled = true;
        elements.analyzeText.classList.add('hidden');
        elements.analyzeSpinner.classList.remove('hidden');

        setTimeout(() => {
          try {
            if (!validation.validateBusinessProfile()) {
              return;
            }

            const business = {
              w2: parseFloat(document.getElementById('totalW2').value) || 0,
              ubia: parseFloat(document.getElementById('totalUBIA').value) || 0,
              ptet: parseFloat(document.getElementById('totalPTET').value) || 0,
              isSSTB: document.getElementById('isSSTB').value
            };

            const results = [];
            const logs = [];
            const ownerCount = parseInt(elements.numOwners.value) || 1;

            for (let i = 1; i <= ownerCount; i++) {
              if (!validation.validateOwner(i)) {
                return;
              }

              const owner = {
                label: document.getElementById(`ownerLabel${i}`).value || `Owner ${i}`,
                filingStatus: document.getElementById(`filingStatus${i}`).value,
                taxableIncome: parseFloat(document.getElementById(`taxableIncome${i}`).value) || 0,
                netCapitalGain: parseFloat(document.getElementById(`netCapGain${i}`).value) || 0,
                qbi: parseFloat(document.getElementById(`qbiAllocated${i}`).value) || 0,
                ownershipPercentage: (parseFloat(document.getElementById(`ownershipPct${i}`).value) || 0) / 100,
                materiallyParticipates: document.getElementById(`matPart${i}`).value
              };

              // Calculate allocations
              business.w2Allocation = business.w2 * owner.ownershipPercentage;
              business.ubiaAllocation = business.ubia * owner.ownershipPercentage;
              business.ptetAllocation = business.ptet * owner.ownershipPercentage;

              const log = [`── ${owner.label} ──`];
              
              log.push('• Current Law (2025)');
              const currentResult = calculator.calculateCurrent(owner, business, log);
              
              log.push('• Final Bill (OBBB 2026+)');
              const obbbResult = calculator.calculateOBBB(owner, business, log);
              
              logs.push(log.join('\n'));

              const difference = obbbResult.final - currentResult.final;
              const differenceClass = difference > 0 ? 'status-good' : difference < 0 ? 'status-bad' : '';

              results.push(`
                <tr>
                  <td class="font-medium">${owner.label}</td>
                  <td class="text-right">${utils.formatCurrency(currentResult.final)}</td>
                  <td class="text-right">${utils.formatCurrency(obbbResult.final)}</td>
                  <td class="text-right ${differenceClass}">${utils.formatCurrency(difference)}</td>
                </tr>
              `);
            }

            elements.resultsBody.innerHTML = results.join('');
            elements.resultsContainer.classList.remove('hidden');
            elements.detailsLog.textContent = logs.join('\n\n');

            // Smooth scroll to results
            elements.resultsContainer.scrollIntoView({ 
              behavior: 'smooth',
              block: 'start'
            });

          } catch (error) {
            console.error('Calculation error:', error);
            alert('An error occurred during calculation. Please check your inputs and try again.');
          } finally {
            // Reset loading state
            elements.analyzeBtn.disabled = false;
            elements.analyzeText.classList.remove('hidden');
            elements.analyzeSpinner.classList.add('hidden');
          }
        }, 100); // Small delay to show loading state
      };

      // Initialization
      const init = () => {
        // Cache DOM elements
        elements.numOwners = document.getElementById('numOwners');
        elements.ownersContainer = document.getElementById('ownersContainer');
        elements.analyzeBtn = document.getElementById('analyzeBtn');
        elements.resultsContainer = document.getElementById('resultsContainer');
        elements.resultsBody = document.getElementById('resultsBody');
        elements.detailsLog = document.getElementById('detailsLog');
        elements.analyzeText = document.getElementById('analyzeText');
        elements.analyzeSpinner = document.getElementById('analyzeSpinner');

        // Event listeners
        elements.numOwners.addEventListener('input', ownerManager.generateOwnerInputs);
        
        // Generate initial owner inputs
        ownerManager.generateOwnerInputs();
      };

      // Public API
      return {
        init,
        runAnalysis
      };
    })();

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', QBICalculator.init);
  </script>
</body>
</html>
