<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Tax Strategy Calculator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.8.0/esm/index.js" type="module"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Loading Tax Calculator...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Simple icon component using text symbols
        const Icon = ({ name, className = "" }) => {
            const icons = {
                'info': '‚ÑπÔ∏è',
                'trending-up': 'üìà',
                'check-circle': '‚úÖ',
                'alert-triangle': '‚ö†Ô∏è',
                'calculator': 'üßÆ'
            };
            
            return (
                <span className={`icon ${className}`}>
                    {icons[name] || '‚Ä¢'}
                </span>
            );
        };

        // Strategy Library and Constants
        const STRATEGY_LIBRARY = [
            {
                id: 'QUANT_DEALS_01',
                name: 'Quantino DEALS',
                category: 'Investment',
                hierarchy: 1,
                description: 'Generates short-term capital losses to offset capital gains.',
                inputRequired: 'investmentAmount',
                fedCalcLogic: (inv) => ({ capitalLoss: inv * 0.30 }),
            },
            {
                id: 'EQUIP_S179_01',
                name: 'Equipment Financing (Sec 179)',
                category: 'Above AGI Deduction',
                hierarchy: 2,
                description: 'Deducts the full cost of qualifying equipment in Year 1.',
                inputRequired: 'equipmentCost',
                fedCalcLogic: (cost, income) => ({ deduction: Math.min(cost, income, 1220000) }),
                njCalcLogic: (cost) => ({ deduction: Math.min(cost, 25000), addBack: Math.max(0, cost - 25000) }),
            },
            {
                id: 'CHAR_CLAT_01',
                name: 'Charitable Lead Annuity Trust (CLAT)',
                category: 'Below AGI Deduction',
                hierarchy: 3,
                description: 'Donates appreciated assets for a significant itemized deduction.',
                inputRequired: 'charitableIntent',
                fedCalcLogic: (intent, agi) => ({ deduction: Math.min(intent, agi * 0.30) }),
                nyCalcLogic: (intent, agi) => ({ deduction: Math.min(intent, agi * 0.30) * 0.5 }),
                njCalcLogic: () => ({ deduction: 0 }),
            },
            {
                id: 'OG_USENERGY_01',
                name: 'Oil & Gas (US Energy)',
                category: 'Below AGI Deduction',
                hierarchy: 4,
                description: 'Provides large upfront deductions via Intangible Drilling Costs (IDCs).',
                inputRequired: 'ogInvestment',
                fedCalcLogic: (inv) => ({ deduction: inv * 0.70 }),
                njCalcLogic: () => ({ deduction: 0 }),
            },
            {
                id: 'FILM_SEC181_01',
                name: 'Film Financing (Sec 181)',
                category: 'Below AGI Deduction',
                hierarchy: 5,
                description: '100% upfront deduction of investment in a qualified film production.',
                inputRequired: 'filmInvestment',
                fedCalcLogic: (inv) => ({ deduction: inv }),
                njCalcLogic: () => ({ deduction: 0 }),
            },
            {
                id: 'QRP_DB_SOLO401K_01',
                name: 'Qualified Retirement Plan (DB/Solo 401k)',
                category: 'Above AGI Deduction',
                hierarchy: 6,
                description: 'Maximizes tax-deferred contributions for business owners.',
                inputRequired: 'qrpContribution',
                fedCalcLogic: (contrib) => ({ deduction: contrib }),
            },
            {
                id: 'QBI_FINAL_01',
                name: 'QBI Final Calculation',
                category: 'Final Tuning',
                hierarchy: 7,
                description: '20% deduction for Qualified Business Income if income is below thresholds.',
                inputRequired: 'businessIncome',
                fedCalcLogic: (taxableIncome, businessIncome) => {
                    const threshold = 383900;
                    if (businessIncome > 1 && taxableIncome <= threshold) {
                        return { deduction: Math.min(businessIncome * 0.20, taxableIncome * 0.20) };
                    }
                    return { deduction: 0 };
                },
                nyCalcLogic: () => ({ deduction: 0 }),
                njCalcLogic: () => ({ deduction: 0 }),
            },
        ];

        const FED_TAX_BRACKETS = [
            { rate: 0.10, min: 0, max: 23200 },
            { rate: 0.12, min: 23201, max: 94300 },
            { rate: 0.22, min: 94301, max: 201050 },
            { rate: 0.24, min: 201051, max: 383900 },
            { rate: 0.32, min: 383901, max: 487450 },
            { rate: 0.35, min: 487451, max: 731200 },
            { rate: 0.37, min: 731201, max: Infinity },
        ];

        const NY_TAX_BRACKETS = [
            { rate: 0.04, min: 0, max: 17150 },
            { rate: 0.045, min: 17151, max: 23900 },
            { rate: 0.0525, min: 23901, max: 27900 },
            { rate: 0.0585, min: 27901, max: 161550 },
            { rate: 0.0625, min: 161551, max: 323200 },
            { rate: 0.0685, min: 323201, max: 2155350 },
            { rate: 0.0965, min: 2155351, max: 5000000 },
            { rate: 0.103, min: 5000001, max: 25000000 },
            { rate: 0.109, min: 25000001, max: Infinity },
        ];

        const NJ_TAX_BRACKETS = [
            { rate: 0.014, min: 0, max: 20000 },
            { rate: 0.0175, min: 20001, max: 35000 },
            { rate: 0.035, min: 35001, max: 40000 },
            { rate: 0.05525, min: 40001, max: 75000 },
            { rate: 0.0637, min: 75001, max: 500000 },
            { rate: 0.0897, min: 500001, max: 1000000 },
            { rate: 0.1075, min: 1000001, max: Infinity },
        ];

        const STANDARD_DEDUCTION = 29200;

        const INITIAL_CLIENT_DATA = {
            w2Income: 500000,
            businessIncome: 2000000,
            capitalGains: 1000000,
            state: 'NY',
            investmentAmount: 5000000,
            equipmentCost: 500000,
            charitableIntent: 2000000,
            ogInvestment: 1000000,
            filmInvestment: 250000,
            qrpContribution: 200000,
        };

        // Helper Functions
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('en-US', { 
                style: 'currency', 
                currency: 'USD', 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            }).format(Math.max(0, value || 0));
        };

        const calculateTax = (income, brackets) => {
            if (income <= 0) return 0;
            let tax = 0;
            let remainingIncome = income;
            
            for (const bracket of brackets) {
                if (remainingIncome <= 0) break;
                const bracketMin = bracket.min || 0;
                const bracketMax = bracket.max === Infinity ? remainingIncome + bracketMin : bracket.max;
                const taxableInBracket = Math.min(remainingIncome, bracketMax - bracketMin);
                
                if (taxableInBracket > 0) {
                    tax += taxableInBracket * bracket.rate;
                    remainingIncome -= taxableInBracket;
                }
            }
            return Math.max(0, tax);
        };

        // Components
        const ClientInputForm = ({ data, setData }) => {
            const handleInputChange = (e) => {
                const { name, value } = e.target;
                const numericValue = Number(value.replace(/[^0-9.-]+/g, '')) || 0;
                setData(prev => ({ ...prev, [name]: Math.max(0, numericValue) }));
            };

            const handleSelectChange = (e) => {
                const { name, value } = e.target;
                setData(prev => ({ ...prev, [name]: value }));
            };

            const renderInput = (name, label) => (
                <div key={name}>
                    <label className="block text-sm font-medium text-gray-600">{label}</label>
                    <input
                        type="text"
                        name={name}
                        value={data[name]?.toLocaleString('en-US') || '0'}
                        onChange={handleInputChange}
                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                    />
                </div>
            );

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        <Icon name="info" className="mr-3 text-blue-500" /> Client Financial Inputs
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {renderInput('w2Income', 'W-2 Income')}
                        {renderInput('businessIncome', 'Business Income (Sch C/K-1)')}
                        {renderInput('capitalGains', 'Long-Term Capital Gains')}
                        <div>
                            <label className="block text-sm font-medium text-gray-600">State</label>
                            <select 
                                name="state" 
                                value={data.state} 
                                onChange={handleSelectChange} 
                                className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white"
                            >
                                <option value="NY">New York (NY)</option>
                                <option value="NJ">New Jersey (NJ)</option>
                            </select>
                        </div>
                        {renderInput('investmentAmount', 'Quantino Investment')}
                        {renderInput('equipmentCost', 'Equipment Cost')}
                        {renderInput('charitableIntent', 'Charitable Intent (Assets)')}
                        {renderInput('ogInvestment', 'Oil & Gas Investment')}
                        {renderInput('filmInvestment', 'Film Financing Investment')}
                        {renderInput('qrpContribution', 'QRP Contribution (DB/Solo 401k)')}
                    </div>
                </div>
            );
        };

        const StrategyDashboard = ({ enabledStrategies }) => {
            return (
                <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        <Icon name="trending-up" className="mr-3 text-green-500" /> Tax Strategy Selection
                    </h2>
                    <div className="space-y-4">
                        {STRATEGY_LIBRARY.map(strategy => {
                            const isEnabled = enabledStrategies[strategy.id];
                            return (
                                <div key={strategy.id} className={`p-4 rounded-lg border transition-all duration-300 ${
                                    isEnabled ? 'bg-blue-50 border-blue-300' : 'bg-gray-50 border-gray-200'
                                }`}>
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center">
                                            <span className={`mr-3 font-bold text-lg ${
                                                isEnabled ? 'text-blue-600' : 'text-gray-500'
                                            }`}>
                                                {strategy.hierarchy}.
                                            </span>
                                            <label className="font-bold text-lg text-gray-800">
                                                {strategy.name}
                                            </label>
                                        </div>
                                        <div className="flex items-center">
                                            <span className={`text-sm font-semibold mr-4 ${
                                                isEnabled ? 'text-blue-600' : 'text-gray-500'
                                            }`}>
                                                {isEnabled ? 'ENABLED' : 'DISABLED'}
                                            </span>
                                            <input
                                                type="checkbox"
                                                checked={isEnabled}
                                                disabled
                                                className="h-6 w-6 rounded text-blue-600 focus:ring-blue-500 border-gray-300 disabled:opacity-50"
                                            />
                                        </div>
                                    </div>
                                    <p className="text-sm text-gray-600 mt-2 ml-7">{strategy.description}</p>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const SimpleBarChart = ({ data }) => {
            const maxValue = Math.max(...data.map(d => d.Total));
            
            return (
                <div className="space-y-4">
                    {data.map((item, index) => (
                        <div key={index} className="space-y-2">
                            <div className="flex justify-between items-center">
                                <span className="font-medium text-gray-700">{item.name}</span>
                                <span className="font-bold text-gray-900">{formatCurrency(item.Total)}</span>
                            </div>
                            <div className="relative">
                                <div className="w-full bg-gray-200 rounded-full h-8">
                                    <div 
                                        className={`h-8 rounded-full flex items-center justify-end pr-2 text-white text-sm font-medium ${
                                            index === 0 ? 'bg-red-500' : 'bg-green-500'
                                        }`}
                                        style={{ width: `${(item.Total / maxValue) * 100}%` }}
                                    >
                                        {item.Total > maxValue * 0.3 ? formatCurrency(item.Total) : ''}
                                    </div>
                                </div>
                            </div>
                            <div className="flex justify-between text-sm text-gray-600">
                                <span>Federal: {formatCurrency(item.Federal)}</span>
                                <span>State: {formatCurrency(item.State)}</span>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const ResultsSummary = ({ results }) => {
            if (!results?.baseline || !results?.withStrategies) {
                return (
                    <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">Results Summary</h2>
                        <p className="text-gray-500">Loading calculation results...</p>
                    </div>
                );
            }

            const data = [
                { 
                    name: 'Baseline', 
                    Federal: results.baseline.fedTax || 0, 
                    State: results.baseline.stateTax || 0, 
                    Total: results.baseline.totalTax || 0 
                },
                { 
                    name: 'With Strategies', 
                    Federal: results.withStrategies.fedTax || 0, 
                    State: results.withStrategies.stateTax || 0, 
                    Total: results.withStrategies.totalTax || 0 
                },
            ];
            
            const totalSavings = (results.baseline.totalTax || 0) - (results.withStrategies.totalTax || 0);
            const savingsPercentage = results.baseline.totalTax > 0 ? (totalSavings / results.baseline.totalTax) * 100 : 0;
            
            return (
                <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">Results Summary</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                        <div className="bg-red-50 p-4 rounded-lg border border-red-200">
                            <h3 className="text-sm font-semibold text-red-700">Baseline Tax Liability</h3>
                            <p className="text-3xl font-bold text-red-900">{formatCurrency(results.baseline.totalTax)}</p>
                        </div>
                        <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h3 className="text-sm font-semibold text-green-700">Tax With Strategies</h3>
                            <p className="text-3xl font-bold text-green-900">{formatCurrency(results.withStrategies.totalTax)}</p>
                        </div>
                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h3 className="text-sm font-semibold text-blue-700">Total Tax Savings</h3>
                            <p className="text-3xl font-bold text-blue-900">{formatCurrency(totalSavings)}</p>
                            <p className="text-sm font-medium text-blue-600">({savingsPercentage.toFixed(1)}% reduction)</p>
                        </div>
                    </div>
                    <SimpleBarChart data={data} />
                </div>
            );
        };

        const DynamicInsights = ({ insights }) => {
            if (!insights || insights.length === 0) {
                return (
                    <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                         <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <Icon name="check-circle" className="mr-3 text-gray-400" /> Dynamic Insights & Alerts
                        </h2>
                        <p className="text-gray-500">No specific alerts or insights to show. Enable strategies to see potential outcomes.</p>
                    </div>
                );
            }

            const getColor = (type) => {
                switch (type) {
                    case 'warning': return 'bg-yellow-50 border-yellow-200';
                    case 'insight': return 'bg-green-50 border-green-200';
                    default: return 'bg-blue-50 border-blue-200';
                }
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        <Icon name="check-circle" className="mr-3 text-green-500" /> Dynamic Insights & Alerts
                    </h2>
                    <div className="space-y-3">
                        {insights.map((insight, index) => (
                            <div key={index} className={`flex items-start p-3 rounded-lg border ${getColor(insight.type)}`}>
                                <Icon name={insight.type === 'warning' ? 'alert-triangle' : 'check-circle'} 
                                      className={`mr-3 ${insight.type === 'warning' ? 'text-yellow-500' : 'text-green-500'}`} />
                                <p className="text-sm text-gray-700">{insight.text}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Main App Component
        function App() {
            const [clientData, setClientData] = useState(INITIAL_CLIENT_DATA);
            
            const calculationResults = useMemo(() => {
                try {
                    const enabledStrategies = STRATEGY_LIBRARY.reduce((acc, s) => {
                        const inputValue = clientData[s.inputRequired] || 0;
                        acc[s.id] = inputValue > 1;
                        return acc;
                    }, {});

                    // Baseline calculations
                    const baseline = {};
                    baseline.ordinaryIncome = (clientData.w2Income || 0) + (clientData.businessIncome || 0);
                    baseline.fedTaxableIncome = Math.max(0, baseline.ordinaryIncome - STANDARD_DEDUCTION);
                    baseline.fedOrdinaryTax = calculateTax(baseline.fedTaxableIncome, FED_TAX_BRACKETS);
                    baseline.fedCapitalGainsTax = (clientData.capitalGains || 0) * 0.20;
                    baseline.fedTax = baseline.fedOrdinaryTax + baseline.fedCapitalGainsTax;
                    
                    const stateBrackets = clientData.state === 'NY' ? NY_TAX_BRACKETS : NJ_TAX_BRACKETS;
                    baseline.stateTaxableIncome = baseline.ordinaryIncome + (clientData.capitalGains || 0);
                    baseline.stateTax = calculateTax(baseline.stateTaxableIncome, stateBrackets);
                    baseline.totalTax = baseline.fedTax + baseline.stateTax;

                    // Strategy calculations
                    const withStrategies = {};
                    let fedDeductions = { aboveAGI: 0, belowAGI: 0, qbi: 0 };
                    let stateDeductions = { aboveAGI: 0, belowAGI: 0 };
                    let fedCapitalGains = clientData.capitalGains || 0;
                    let stateCapitalGains = clientData.capitalGains || 0;
                    let njAddBack = 0;
                    let insights = [];
                    let qbiBaseIncome = clientData.businessIncome || 0;

                    // Apply strategies in hierarchy order
                    STRATEGY_LIBRARY.forEach(strategy => {
                        if (enabledStrategies[strategy.id]) {
                            try {
                                switch (strategy.id) {
                                    case 'QUANT_DEALS_01': {
                                        const result = strategy.fedCalcLogic(clientData.investmentAmount || 0);
                                        const lossToApply = Math.min(fedCapitalGains, result.capitalLoss);
                                        fedCapitalGains -= lossToApply;
                                        stateCapitalGains -= lossToApply;
                                        const unusedLoss = result.capitalLoss - lossToApply;
                                        if (unusedLoss > 0) {
                                            const ordinaryOffset = Math.min(unusedLoss, 3000);
                                            fedDeductions.belowAGI += ordinaryOffset;
                                            stateDeductions.belowAGI += ordinaryOffset;
                                            insights.push({ 
                                                type: 'info', 
                                                text: `Quantino generated ${formatCurrency(result.capitalLoss)} in losses. ${formatCurrency(lossToApply)} offset gains, and ${formatCurrency(ordinaryOffset)} offset ordinary income.` 
                                            });
                                        }
                                        break;
                                    }
                                    case 'EQUIP_S179_01': {
                                        const fedResult = strategy.fedCalcLogic(clientData.equipmentCost || 0, clientData.businessIncome || 0);
                                        fedDeductions.aboveAGI += fedResult.deduction;
                                        if (clientData.state === 'NY') {
                                            stateDeductions.aboveAGI += fedResult.deduction;
                                        } else {
                                            const njResult = strategy.njCalcLogic(clientData.equipmentCost || 0);
                                            stateDeductions.aboveAGI += njResult.deduction;
                                            njAddBack = njResult.addBack;
                                            if (njAddBack > 0) {
                                                insights.push({ 
                                                    type: 'warning', 
                                                    text: `A ${formatCurrency(njAddBack)} depreciation add-back is required for NJ.` 
                                                });
                                            }
                                        }
                                        insights.push({ 
                                            type: 'insight', 
                                            text: `Equipment purchase generated a ${formatCurrency(fedResult.deduction)} federal deduction.` 
                                        });
                                        break;
                                    }
                                    case 'CHAR_CLAT_01': {
                                        let agiForCharity = (clientData.w2Income || 0) + (clientData.businessIncome || 0) - fedDeductions.aboveAGI;
                                        const fedResult = strategy.fedCalcLogic(clientData.charitableIntent || 0, agiForCharity);
                                        fedDeductions.belowAGI += fedResult.deduction;
                                        if (clientData.state === 'NY') {
                                            const nyResult = strategy.nyCalcLogic(clientData.charitableIntent || 0, agiForCharity);
                                            stateDeductions.belowAGI += nyResult.deduction;
                                            insights.push({ 
                                                type: 'info', 
                                                text: `CLAT created a ${formatCurrency(fedResult.deduction)} federal deduction and a ${formatCurrency(nyResult.deduction)} NY deduction.` 
                                            });
                                        } else {
                                            insights.push({ 
                                                type: 'info', 
                                                text: `CLAT created a ${formatCurrency(fedResult.deduction)} federal deduction. Not deductible in NJ.` 
                                            });
                                        }
                                        break;
                                    }
                                    case 'OG_USENERGY_01': {
                                        const fedResult = strategy.fedCalcLogic(clientData.ogInvestment || 0);
                                        fedDeductions.belowAGI += fedResult.deduction;
                                        if (clientData.state === 'NY') {
                                            stateDeductions.belowAGI += fedResult.deduction;
                                        }
                                        insights.push({ 
                                            type: 'info', 
                                            text: `Oil & Gas investment generated a ${formatCurrency(fedResult.deduction)} federal deduction.` 
                                        });
                                        break;
                                    }
                                    case 'FILM_SEC181_01': {
                                        const fedResult = strategy.fedCalcLogic(clientData.filmInvestment || 0);
                                        fedDeductions.belowAGI += fedResult.deduction;
                                        if (clientData.state === 'NY') {
                                            stateDeductions.belowAGI += fedResult.deduction;
                                        }
                                        insights.push({ 
                                            type: 'insight', 
                                            text: `Film financing generated a ${formatCurrency(fedResult.deduction)} active loss deduction.` 
                                        });
                                        break;
                                    }
                                    case 'QRP_DB_SOLO401K_01': {
                                        const fedResult = strategy.fedCalcLogic(clientData.qrpContribution || 0);
                                        fedDeductions.aboveAGI += fedResult.deduction;
                                        stateDeductions.aboveAGI += fedResult.deduction;
                                        qbiBaseIncome -= fedResult.deduction;
                                        insights.push({ 
                                            type: 'insight', 
                                            text: `QRP contribution of ${formatCurrency(fedResult.deduction)} provides federal and state deduction.` 
                                        });
                                        break;
                                    }
                                    case 'QBI_FINAL_01': {
                                        let fedTaxableIncomePreQBI = (clientData.w2Income || 0) + (clientData.businessIncome || 0) - fedDeductions.aboveAGI - STANDARD_DEDUCTION - fedDeductions.belowAGI;
                                        const fedResult = strategy.fedCalcLogic(fedTaxableIncomePreQBI, qbiBaseIncome);
                                        fedDeductions.qbi = fedResult.deduction;
                                        if (fedResult.deduction > 0) {
                                            insights.push({ 
                                                type: 'insight', 
                                                text: `QBI deduction of ${formatCurrency(fedResult.deduction)} unlocked.` 
                                            });
                                        }
                                        break;
                                    }
                                }
                            } catch (strategyError) {
                                console.error(`Error in strategy ${strategy.id}:`, strategyError);
                            }
                        }
                    });
                    
                    // Final calculations with strategies
                    withStrategies.fedTaxableIncome = Math.max(0, 
                        (clientData.w2Income || 0) + (clientData.businessIncome || 0) - 
                        fedDeductions.aboveAGI - STANDARD_DEDUCTION - fedDeductions.belowAGI - fedDeductions.qbi
                    );
                    withStrategies.fedOrdinaryTax = calculateTax(withStrategies.fedTaxableIncome, FED_TAX_BRACKETS);
                    withStrategies.fedCapitalGainsTax = fedCapitalGains * 0.20;
                    withStrategies.fedTax = withStrategies.fedOrdinaryTax + withStrategies.fedCapitalGainsTax;
                    
                    withStrategies.stateTaxableIncome = Math.max(0,
                        (clientData.w2Income || 0) + (clientData.businessIncome || 0) - 
                        stateDeductions.aboveAGI - stateDeductions.belowAGI + njAddBack + stateCapitalGains
                    );
                    withStrategies.stateTax = calculateTax(withStrategies.stateTaxableIncome, stateBrackets);
                    withStrategies.totalTax = withStrategies.fedTax + withStrategies.stateTax;
                    withStrategies.insights = insights;

                    return { baseline, withStrategies, enabledStrategies };

                } catch (error) {
                    console.error('Calculation error:', error);
                    return {
                        baseline: { fedTax: 0, stateTax: 0, totalTax: 0 },
                        withStrategies: { fedTax: 0, stateTax: 0, totalTax: 0, insights: [] },
                        enabledStrategies: {}
                    };
                }
            }, [clientData]);

            return (
                <div className="min-h-screen bg-gray-50 font-sans p-4 sm:p-6 lg:p-8">
                    <div className="max-w-7xl mx-auto">
                        <header className="mb-8">
                            <h1 className="text-4xl font-extrabold text-gray-900 tracking-tight">
                                Interactive Tax Strategy Calculator
                            </h1>
                            <p className="mt-2 text-lg text-gray-600">
                                Model the impact of advanced tax strategies on a client's liability in real-time.
                            </p>
                        </header>
                        <main className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div className="space-y-8">
                                <ClientInputForm data={clientData} setData={setClientData} />
                                <StrategyDashboard enabledStrategies={calculationResults.enabledStrategies} />
                            </div>
                            <div className="space-y-8">
                                <ResultsSummary results={calculationResults} />
                                <DynamicInsights insights={calculationResults.withStrategies.insights} />
                            </div>
                        </main>
                    </div>
                </div>
            );
        }

        // Simple initialization - no complex library waiting
        if (window.React && window.ReactDOM) {
            ReactDOM.render(<App />, document.getElementById('root'));
        } else {
            console.error('React libraries not loaded');
        }
    </script>
</body>
</html>
